#!/usr/bin/env bash

export PANE_FILE="/tmp/peco-glimpse-$$.pane"

EXIT_HANDLER="kill_pane_from_pane_file ${PANE_FILE}"
trap "${EXIT_HANDLER}" EXIT

SELECTED="$(</dev/null rg --vimgrep "${@}" | fzf --reverse --bind 'tab:execute(peco_glimpse {})')"
if [[ $? -eq "0" && -n "${SELECTED}" ]] ; then
    ${EXIT_HANDLER}
    FILES="$(echo "${SELECTED}" | awk -F ':' '{print "+" $2 ":" $3 " " $1}')"
    CMD="${EDITOR} ${FILES}"
    echo -n "${CMD}" | tmux loadb -b "rgp $* $(date +%s)" -
    exec ${CMD}
fi
